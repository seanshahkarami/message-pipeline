#!/bin/sh

while true; do
  # copy plugin units to systemd runtime units
  cp /wagglerw/systemd/system/waggle-plugin-* /run/systemd/system

  services=$(ls /run/systemd/system | grep waggle-plugin)

  case $(systemctl get-default) in
    waggle-core.target)
      echo 'Ensuring plugins are stopped.'
      systemctl stop $services
      ;;
    waggle-platform.target)
      echo 'Ensuring plugins are started.'
      systemctl start $services
      ;;
  esac

  sleep 60
done
