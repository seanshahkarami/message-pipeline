#!/usr/bin/env python3
import argparse
import json
import re
import subprocess


def get_certfile_subject(filename):
    output = subprocess.check_output([
        'openssl',
        'x509',
        '-noout',
        '-subject',
        '-in', filename,
    ])

    return dict(re.findall('/([^=]+)=([^/]+)', output.decode().strip()))


def start_shovels():
    node_uri = 'amqp://localhost'
    beehive_uri = (
        'amqps://beehive:23181'
        '?auth_mechanism=external'
        '&cacertfile=/usr/lib/waggle/SSL/waggleca/cacert.pem'
        '&certfile=/usr/lib/waggle/SSL/node/cert.pem'
        '&keyfile=/usr/lib/waggle/SSL/node/key.pem'
        '&verify=verify_peer'
    )

    subject = get_certfile_subject('/usr/lib/waggle/SSL/node/cert.pem')
    username = subject['CN']

    push_to_beehive_shovel_config = {
        'src-uri': node_uri,
        'src-queue': 'to-beehive',
        'dest-uri': beehive_uri,
        'dest-exchange': 'messages',
        'publish-properties': {
            'delivery_mode': 2,
            'user_id': username,
        }
    }

    pull_from_beehive_shovel_config = {
        'src-uri': beehive_uri,
        'src-queue': 'to-{}'.format(username),
        'dest-uri': node_uri,
        'dest-queue': 'messages',
        'publish-properties': {
            'delivery_mode': 2,
        }
    }

    subprocess.check_output([
        'rabbitmqctl',
        'set_parameter',
        'shovel',
        'push-to-beehive',
        json.dumps(push_to_beehive_shovel_config),
    ])

    subprocess.check_output([
        'rabbitmqctl',
        'set_parameter',
        'shovel',
        'pull-from-beehive',
        json.dumps(pull_from_beehive_shovel_config),
    ])


def stop_shovels():
    subprocess.check_output([
        'rabbitmqctl',
        'clear_parameter',
        'shovel',
        'push-to-beehive',
    ])

    subprocess.check_output([
        'rabbitmqctl',
        'clear_parameter',
        'shovel',
        'pull-from-beehive',
    ])


actions = {
    'start': start_shovels,
    'stop': stop_shovels,
}


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('action', choices=actions.keys())
    args = parser.parse_args()
    actions[args.action]()


if __name__ == '__main__':
    main()
