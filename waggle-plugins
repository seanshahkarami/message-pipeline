#!/usr/bin/env python3
import argparse
import json
import os
import secrets
import subprocess


def exec_rabbitmqctl(args):
    rabbitmqctl = ['docker', 'exec', '-ti', 'rabbitmq-dev', 'rabbitmqctl']
    return subprocess.check_output(rabbitmqctl + args)


def add_rabbitmq_user(username, password):
    try:
        exec_rabbitmqctl(['add_user', username, password])
    except subprocess.CalledProcessError:
        exec_rabbitmqctl(['change_password', username, password])

    inqueue = 'in-' + username
    config_permissions = '^{}$'.format(inqueue)
    write_permissions = '^data$'
    read_permissions = '^{}$'.format(inqueue)

    for vhost in ['node1', 'node2']:
        exec_rabbitmqctl([
            'set_permissions',
            '-p', vhost,
            username,
            config_permissions,
            write_permissions,
            read_permissions,
        ])


run_plugin_template = '''
#!/bin/sh

export WAGGLE_PLUGIN_CREDENTIALS={username}:{password}

{executable}
'''.strip()


def format_template(username, password, executable):
    return run_plugin_template.format(
        username=username,
        password=password,
        executable=executable)


def enable_plugin(plugin_dir):
    config = read_config_file(os.path.join(plugin_dir, 'plugin.json'))

    username = 'plugin-{}-{}-{}'.format(
        config['plugin_id'],
        config['plugin_version'],
        config['plugin_instance'])

    password = secrets.token_urlsafe(32)

    print('enabling', username)
    add_rabbitmq_user(username, password)

    filename = 'run/{}'.format(username)

    with open(filename, 'w') as file:
        file.writelines(format_template(
                username=username,
                password=password,
                executable=os.path.abspath(os.path.join(plugin_dir, 'plugin'))))

    os.chmod(filename, 0o755)


def enable_plugins(plugins):
    os.makedirs('run', exist_ok=True)

    for plugin in plugins:
        enable_plugin(plugin)


def disable_plugins(plugins):
    for plugin in plugins:
        disable_plugin(plugin)


def disable_plugin(plugin_dir):
    config = read_config_file(os.path.join(plugin_dir, 'plugin.json'))

    username = 'plugin-{}-{}-{}'.format(
        config['plugin_id'],
        config['plugin_version'],
        config['plugin_instance'])

    try:
        exec_rabbitmqctl(['delete_user', username])
    except subprocess.CalledProcessError:
        pass

    try:
        os.remove('run/{}'.format(username))
    except Exception:
        pass


def read_config_file(filename):
    with open(filename) as file:
        return json.load(file)


def main():
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(dest='subcommand', required=True)

    parser_enable = subparsers.add_parser('enable')
    parser_enable.add_argument('plugins', nargs='+')

    parser_disable = subparsers.add_parser('disable')
    parser_disable.add_argument('plugins', nargs='+')

    args = parser.parse_args()

    if args.subcommand == 'enable':
        enable_plugins(args.plugins)
    elif args.subcommand == 'disable':
        disable_plugins(args.plugins)


if __name__ == '__main__':
    main()
